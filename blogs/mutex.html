<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../projects/style.css" />
    <link rel="stylesheet" href="../projects/media.css" />
    <title>Mutex</title>
</head>

<body>
    <div style="border-bottom: 3px solid gainsboro;">
        <nav id="desktop-nav">
            <div class="logo"><a href="/" style="text-decoration: none;">Rajesh Shah</a></div>
            <ul class="nav-links">
                <li><a href="../#about" style="text-decoration: none;">About</a></li>
                <li><a href="../#projects" style="text-decoration: none;">Projects</a></li>
                <li><a href="../#blogs" style="text-decoration: none;">Blogs</a></li>
                <li><a href="../#contact" style="text-decoration: none;">Contact</a></li>
            </ul>
        </nav>
        <nav id="hamburger-nav">
            <div class="logo">Rajesh Shah</div>
            <div class="hamburger-menu">
                <div class="hamburger-icon" onclick="toggleMenu()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="menu-links">
                    <li><a href="../#about" onclick="toggleMenu()">About</a></li>
                    <li><a href="../#projects" onclick="toggleMenu()">Projects</a></li>
                    <li><a href="../#blogs" onclick="toggleMenu()">Blogs</a></li>
                    <li><a href="../#contact" onclick="toggleMenu()">Contact</a></li>
                </div>
            </div>
        </nav>
    </div>
    <!--<div id="project_container" style="margin-left: 2%; margin-top: 0.8%; align-items: center; display: flex; flex-direction: column">-->
    <div class="project-container">
        <div class="project-title">
            <p>Mutex in C++</p>
        </div>
        <!--<p style="font-family:Georgia, 'Times New Roman', Times, serif ;font-size: large; margin: 1%;">February 7, 2025</p>-->
        <p class="date-container">February 7, 2025</p>
        <!--<div class="project_pic_container" style="width: 53%; display: flex; justify-content: center;">-->
        <div class="project-pic-container">
            <img src="/assets/blogs/mutex.png" alt="MUTEX IMG" />
        </div>
        <div class="project-details-container">
            <p style="font-size: larger;">
                Mutex
            </p>
            <p>
                Mutex short for mutual exclusion is a synchronization primitive that allows access to shared resource to
                only one thread.
            </p>
            <p>
                Imagine a scenario where two shoppers are adding items (number of garlic) into a shared shopping list.
                Each shopper is modelled as a thread and adding items into the shared shopping list is modelled with an update function.
                In the update function thread adds one garlic each time going in a loop for a total of total_count times.
            </p>
<div class="code_body">
<pre>

    <span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
    <span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;thread&gt;</span>
    
    <span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="p">;</span>
    
    <span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">garlic_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">total_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100000</span><span class="p">;</span>
    
    <span class="kt">void</span><span class="w"> </span><span class="nf">update</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
    <span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">total_count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
    <span class="w">        </span><span class="n">garlic_count</span><span class="o">++</span><span class="p">;</span>
    <span class="w">    </span><span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="w">    </span><span class="kr">thread</span><span class="w"> </span><span class="n">t1</span><span class="p">(</span><span class="n">update</span><span class="p">),</span><span class="w"> </span><span class="n">t2</span><span class="p">(</span><span class="n">update</span><span class="p">);</span>
    <span class="w">    </span><span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="w">    </span><span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Total garlic count is: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">garlic_count</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
    <span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Total garlic count should be: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">total_count</span><span class="o">*</span><span class="mi">2</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

</pre>
</div>
                <p>
                    Since there are two threads t1 and t2 calling the function update which adds 100000 garlics into the shopping list. The output of gralic_count should be 2*100000 = 200000.
                </p>
                <p>
                    Running the above program gives the output:
                </p>
<div class="code_body">
<pre>

    <span class="n">Total</span><span class="w"> </span><span class="n">garlic</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">is</span><span class="o">:</span><span class="w"> </span><span class="mi">156226</span>
    <span class="n">Total</span><span class="w"> </span><span class="n">garlic</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="o">:</span><span class="w"> </span><span class="mi">200000</span>

</pre>
</div>            
                <p>
                    Total garlic count is less than 200000. This is because both the threads are using a shared resource garlic_count and there is nothing that prevents the two threads to access the resource at the same time.
                    This is what is causing the error. Say at a given point garlic_count is 100. Thread 1 reads the count, increase the count by 1 to make it 101.
                    But before it can write the value to the shared variable it is blocked and thread 2 gets it's turn. It reads the count as 100, also increase the count to 101 and writes it to the shared variable.
                    Now, thread 1 gets it's turn. It writes the count value as 101 as well. Thus, the count increases by just 1 instead of 2.
                </p>
                <p>
                    To prevent the above scenario, each thread should have exclusive access to the shared variable until it is done with the process of reading, modifying and updating. It can't be blocked in between these steps.
                    Mutex allow this to happen, which is like a lock that allows exclusive access to the resource. A thread first locks the mutex, then reads-modify and update the resource and then when it is done unlocks it. Only then can a second thread get access to the resource.
                </p>
                <p>
                    Using mutex in the update function.
                </p>

    <div class="code_body">
    <pre>
    
    <span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
    <span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;thread&gt;</span>
    <span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mutex&gt;</span>
            
    <span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">std</span><span class="p">;</span>
            
    <span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">garlic_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">total_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100000</span><span class="p">;</span>
    <span class="n">mutex</span><span class="w"> </span><span class="n">pencil</span><span class="p">;</span>
        
    <span class="kt">void</span><span class="w"> </span><span class="nf">update</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
    <span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">total_count</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
    <span class="w">        </span><span class="c1">// Get the pencil (mutex)</span>
    <span class="w">        </span><span class="n">pencil</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
    <span class="w">        </span><span class="n">garlic_count</span><span class="o">++</span><span class="p">;</span>
    <span class="w">        </span><span class="c1">// Release the pencil (mutex)</span>
    <span class="w">        </span><span class="n">pencil</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
    <span class="w">    </span><span class="p">}</span>
    <span class="p">}</span>
        
    <span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="w">    </span><span class="kr">thread</span><span class="w"> </span><span class="n">t1</span><span class="p">(</span><span class="n">update</span><span class="p">),</span><span class="w"> </span><span class="n">t2</span><span class="p">(</span><span class="n">update</span><span class="p">);</span>
    <span class="w">    </span><span class="n">mutex</span><span class="w"> </span><span class="n">m</span><span class="p">;</span>
    <span class="w">    </span><span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span><span class="w">      </span><span class="c1">// Main blocks here until t1 returns</span>
    <span class="w">    </span><span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Total garlic count is: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">garlic_count</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
    <span class="w">    </span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Total garlic count should be: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">total_count</span><span class="o">*</span><span class="mi">2</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    </pre>
    </div>

                <p>
                    Running the above program gives the output:
                </p>
    
    <div class="code_body">
    <pre>

    <span class="n">Total</span><span class="w"> </span><span class="n">garlic</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">is</span><span class="o">:</span><span class="w"> </span><span class="mi">200000</span>
    <span class="n">Total</span><span class="w"> </span><span class="n">garlic</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">be</span><span class="o">:</span><span class="w"> </span><span class="mi">200000</span>

    </pre>
    </div> 

        </div>
    </div>

    <footer>
        <nav>
            <div class="nav-links-container">
                <ul class="nav-links">
                    <li><a href="../#about">About</a></li>
                    <li><a href="../#projects">Projects</a></li>
                    <li><a href="../#blogs">Blogs</a></li>
                    <li><a href="../#contact">Contact</a></li>
                </ul>
            </div>
        </nav>
        <p>Copyright &#169; 2025 Rajesh Shah. All Rights Reserved.</p>
    </footer>
</body>

</html>